---
title: "STOP-II Metadata Curation"
author: "Emily Hughes"
date: "1/27/2022"
output: html_document
---

Install libraries
```{r}
library(tidyverse)
library(dplyr)
library(jsonlite)
```

Read in files given for STOP-II study. This includes the SAS output about each variable and a manually curated file about the forms and their descriptions.
```{r}
sas_info <- read.csv("../input/METADATA.csv")
file_info <- read.csv("../intermediates/stopii_file_info.csv")
```

Now we can combine this information and clean the dataframe to include only the information we are interested in. Here we will also relabel the columns to be in the standard format.
```{r}
raw <- full_join(sas_info, 
                 file_info %>%
                   mutate(sas_file = toupper(sas_file)) %>%
                   rename(form_description = label),
                 by = c("MEMNAME" = "sas_file")) %>%
  select(MEMNAME, NAME, TYPE, LABEL, form, form_description) %>% 
  rename(data_file_name = MEMNAME,
         variable_id = NAME,
         variable_type = TYPE,
         variable_name = LABEL,
         form_name = form) %>%
  mutate(variable_type = ifelse(variable_type==1, "continuous", ifelse(variable_type==2, "categorical", "unknown")))
```

Save the variable-level data for each form
```{r}
save_var_metadata <- function(df) {
  
  final_df <- data.frame(df %>%
                           select(form_name, data_file_name, form_description) %>%
                           unique())
  
  rownames(final_df) <- NULL
  
  for (ind in c(1:nrow(final_df))) {
    var_df <- df %>%
      filter(form_name == final_df[ind, "form_name"]) %>%
      select(variable_id, variable_name, variable_type) 
    var_df <- data.frame(var_df)
    final_df[ind, 'variable'][[1]] <- list(var_df)
  }
  
  return(final_df)
}

var_df <- save_var_metadata(raw)
```

Now we can save the form level data with the study level data.
```{r}
study <- "STOP II"
study_name <- "Optimizing Primary Stroke Prevention in Children with Sickle Cell Anemia (STOP II)"
study_phs_number <- "phs002386"
study_description <- "https://www.ncbi.nlm.nih.gov/projects/gap/cgi-bin/study.cgi?study_id=phs002386.v1.p1"

save_form_metadata <- function(df) {
  final_df <- data.frame(study, study_name, study_phs_number, study_description)
  final_df[1, 'form'][[1]] <- list(df)
  return(final_df)
}

study_df <- save_form_metadata(var_df)
```


Now we can  write out the information to JSON.
```{r}
my_json <- toJSON(var_df, pretty=FALSE)
test_string_json <- as.character(my_json) # Convert to character/string
fileConn <- file("../output/stopii_metadata.json")
writeLines(test_string_json, fileConn)
close(fileConn)
```
